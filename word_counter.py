import requests
from bs4 import BeautifulSoup
import re
import click


def get_html_of(url):
    resp = requests.get(url) # httpbin.org/ip prints our public ip addr

    if resp.status_code != 200:
        print(f'HTML status code is {resp.status_code}, was expecting 200. Exiting...')
        exit(1)

    return resp.content.decode() # the resp content will be in byte-string hence decode()


def get_all_words(url):
    html = get_html_of(url)
    soup = BeautifulSoup(html, 'html.parser')
    raw_text = soup.get_text()
    return re.findall(r'\w+', raw_text)


def count_occurences(wordlist, min_length):
    word_count = {} # {} is dictionary

    for word in wordlist: # iterate through all_words and find repetitive words
        if len(word) < min_length:
            continue
        if word not in word_count: # if word is not in word_count add it to the dictionary and increment the counter by 1
            word_count[word] = 1
        else: 
            current_count = word_count.get(word)
            word_count[word] = current_count + 1

        return word_count


def sort_words(all_words, min_length):
    occurences = count_occurences(all_words, min_length)
    return sorted(occurences.items(), key=lambda item:item[1], reverse=True) # sort through the words reverse true as this will sort in ascending order


@click.command()
@click.option('--url', '-u', prompt='Web URL', help='URL of webpage to extract from.')
@click.option('--length', '-l', default=0, help='Minimum word length (default: 0, no limit).')
# @click.option('--output', '-o', prompt='File Name', default=False, help='Provide the name of text file to write.')
def main(url, length):
    all_words = get_all_words(url)
    top_words = sort_words(all_words, length)
    # filename = output

    """if filename != False:
        with open(filename, 'w') as file:
            for i in range(len(top_words)):
                file.write(top_words[i][0]) # write all words to file
            print(f"[Success!] Written to {output}")
    else:"""
    for i in range(len(top_words)):
            print(top_words[i][0]) # print all words

if __name__ == '__main__':
    main()